# 第九章、vim 程式編輯器
系統管理員的重要工作就是得要修改與設定某些重要軟體的設定檔，因此至少得要學會一種以上的文字介面的文書編輯器。 在所有的 Linux distributions 上頭都會有的一套文書編輯器就是 vi ，而且很多軟體預設也是使用 vi 做為他們編輯的介面， 因此鳥哥建議您務必要學會使用 vi 這個正規的文書編輯器。此外，vim 是進階版的 vi ， vim 不但可以用不同顏色顯示文字內容，還能夠進行諸如 shell script, C program 等程式編輯功能， 你可以將 vim 視為一種程式編輯器！鳥哥也是用 vim 編輯鳥站的網頁文章呢！ ^_^

## 9.1 vi 與 vim
由前面一路走來，我們一直建議使用文字模式來處理 Linux 系統的設定問題，因為不但可以讓你比較容易瞭解到 Linux 的運作狀況，也比較容易瞭解整個設定的基本精神，更能『保證』你的修改可以順利的被運作。 所以，在 Linux 的系統中使用文字編輯器來編輯你的 Linux 參數設定檔，可是一件很重要的事情呦！也因此呢，系統管理員至少應該要熟悉一種文書處理器的！

在 Linux 的世界中，絕大部分的設定檔都是以 ASCII 的純文字形態存在，因此利用簡單的文字編輯軟體就能夠修改設定了！ 與微軟的 Windows 系統不同的是，如果你用慣了 Microsoft Word 或 Corel Wordperfect 的話，那麼除了 X window 裡面的圖形介面編輯程式(如 xemacs )用起來尚可應付外，在 Linux 的文字模式下，會覺得文書編輯程式都沒有視窗介面來的直觀與方便。
>什麼是純文字檔？其實檔案記錄的就是 0 與 1 ，而我們透過編碼系統來將這些 0 與 1 轉成我們認識的文字就是了。 在第零章裡面的資料表示方式有較多說明，請自行查閱。 ASCII 就是其中一種廣為使用的文字編碼系統，在 ASCII 系統中的圖示與代碼可以參考 http://zh.wikipedia.org/wiki/ASCII呢！
### 9.1.1 為何要學 vim
文書編輯器那麼多，我們之前在第四章也曾經介紹過那簡單好用的 nano ，既然已經學會了 nano ，幹嘛鳥哥還一直要你學這不是很友善的 vi 呢？其實是有原因的啦！因為：

- 所有的 Unix Like 系統都會內建 vi 文書編輯器，其他的文書編輯器則不一定會存在；
- 很多個別軟體的編輯介面都會主動呼叫 vi (例如未來會談到的 crontab, visudo, edquota 等指令)；
- vim 具有程式編輯的能力，可以主動的以字體顏色辨別語法的正確性，方便程式設計；
- 因為程式簡單，編輯速度相當快速。

其實重點是上述的第二點，因為有太多 Linux 上面的指令都預設使用 vi 作為資料編輯的介面，所以你必須、一定要學會 vi ，否則很多指令你根本就無法操作呢！這樣說，有刺激到你務必要學會 vi 的熱情了嗎？ ^_^

那麼什麼是 vim 呢？其實你可以將 vim 視作 vi 的進階版本，vim 可以用顏色或底線等方式來顯示一些特殊的資訊。 舉例來說，當你使用 vim 去編輯一個 C 程式語言的檔案，或者是我們後續會談到的 shell script 腳本程式時，vim 會依據檔案的副檔名或者是檔案內的開頭資訊， 判斷該檔案的內容而自動的呼叫該程式的語法判斷式，再以顏色來顯示程式碼與一般資訊。也就是說， 這個 vim 是個『程式編輯器』啦！甚至一些 Linux 基礎設定檔內的語法，都能夠用 vim 來檢查呢！ 例如我們在第七章談到的 /etc/fstab 這個檔案的內容。

## 9.2 vi 的使用
基本上 vi 共分為三種模式，分別是『一般指令模式』、『編輯模式』與『指令列命令模式』。 這三種模式的作用分別是：

- 一般指令模式 (command mode)
以 vi 打開一個檔案就直接進入一般指令模式了(這是預設的模式，也簡稱為一般模式)。在這個模式中， 你可以使用『上下左右』按鍵來移動游標，你可以使用『刪除字元』或『刪除整列』來處理檔案內容， 也可以使用『複製、貼上』來處理你的文件資料。

- 編輯模式 (insert mode)
在一般指令模式中可以進行刪除、複製、貼上等等的動作，但是卻無法編輯文件內容的！ 要等到你按下『i, I, o, O, a, A, r, R』等任何一個字母之後才會進入編輯模式。注意了！通常在 Linux 中，按下這些按鍵時，在畫面的左下方會出現『 INSERT 或 REPLACE 』的字樣，此時才可以進行編輯。而如果要回到一般指令模式時， 則必須要按下『Esc』這個按鍵即可退出編輯模式。

- 指令列命令模式 (command-line mode)
在一般模式當中，輸入『 : / ? 』三個中的任何一個按鈕，就可以將游標移動到最底下那一列。在這個模式當中， 可以提供你『搜尋資料』的動作，而讀取、存檔、大量取代字元、離開 vi 、顯示行號等等的動作則是在此模式中達成的！

簡單的說，我們可以將這三個模式想成底下的圖示來表示：
<div align=center><img src="/os_note/vim/picture/centos7_vi-mode.gif"></div>
<div align=center>圖9.2.1、vi三種模式的相互關係</div>
注意到上面的圖示，你會發現一般指令模式可與編輯模式及指令列模式切換， 但編輯模式與指令列模式之間不可互相切換喔！這非常重要啦！閒話不多說，我們底下以一個簡單的例子來進行說明吧！

### 9.2.2 按鍵說明
#### 第一部份：一般指令模式可用的按鈕說明，游標移動、複製貼上、搜尋取代等

##### 移動游標的方法
h 或 向左方向鍵(←)	游標向左移動一個字元
j 或 向下方向鍵(↓)	游標向下移動一個字元
k 或 向上方向鍵(↑)	游標向上移動一個字元
l 或 向右方向鍵(→)	游標向右移動一個字元

如果你將右手放在鍵盤上的話，你會發現 hjkl 是排列在一起的，因此可以使用這四個按鈕來移動游標。 如果想要進行多次移動的話，例如向下移動 30 列，可以使用 "30j" 或 "30↓" 的組合按鍵， 亦即加上想要進行的次數(數字)後，按下動作即可！

[Ctrl] + [f]	螢幕『向下』移動一頁，相當於 [Page Down]按鍵 (常用)
[Ctrl] + [b]	螢幕『向上』移動一頁，相當於 [Page Up] 按鍵 (常用)
[Ctrl] + [d]	螢幕『向下』移動半頁
[Ctrl] + [u]	螢幕『向上』移動半頁
\+	游標移動到非空白字元的下一列
\-	游標移動到非空白字元的上一列
n\<space>	那個 n 表示『數字』，例如 20 。按下數字後再按空白鍵，游標會向右移動這一列的 n 個字元。例如 20\<space> 則游標會向後面移動 20 個字元距離。
0 或功能鍵\[Home]	這是數字『 0 』：移動到這一列的最前面字元處 (常用)
$ 或功能鍵\[End]	移動到這一列的最後面字元處(常用)
H	游標移動到這個螢幕的最上方那一列的第一個字元
M	游標移動到這個螢幕的中央那一列的第一個字元
L	游標移動到這個螢幕的最下方那一列的第一個字元
G	移動到這個檔案的最後一列(常用)
nG	n 為數字。移動到這個檔案的第 n 列。例如 20G 則會移動到這個檔案的第 20 列(可配合 :set nu)
gg	移動到這個檔案的第一列，相當於 1G 啊！ (常用)
n\<Enter>	n 為數字。游標向下移動 n 列(常用)

##### 搜尋與取代
/word	向游標之下尋找一個名稱為 word 的字串。例如要在檔案內搜尋 vbird 這個字串，就輸入 /vbird 即可！ (常用)
?word	向游標之上尋找一個字串名稱為 word 的字串。
n	這個 n 是英文按鍵。代表『重複前一個搜尋的動作』。舉例來說， 如果剛剛我們執行 /vbird 去向下搜尋 vbird 這個字串，則按下 n 後，會向下繼續搜尋下一個名稱為 vbird 的字串。如果是執行 ?vbird 的話，那麼按下 n 則會向上繼續搜尋名稱為 vbird 的字串！
N	這個 N 是英文按鍵。與 n 剛好相反，為『反向』進行前一個搜尋動作。 例如 /vbird 後，按下 N 則表示『向上』搜尋 vbird 。
使用 /word 配合 n 及 N 是非常有幫助的！可以讓你重複的找到一些你搜尋的關鍵字！
:n1,n2s/word1/word2/g	n1 與 n2 為數字。在第 n1 與 n2 列之間尋找 word1 這個字串，並將該字串取代為 word2 ！舉例來說，在 100 到 200 列之間搜尋 vbird 並取代為 VBIRD 則：
『:100,200s/vbird/VBIRD/g』。(常用)
:1,$s/word1/word2/g	從第一列到最後一列尋找 word1 字串，並將該字串取代為 word2 ！(常用)
:1,$s/word1/word2/gc	從第一列到最後一列尋找 word1 字串，並將該字串取代為 word2 ！且在取代前顯示提示字元給使用者確認 (confirm) 是否需要取代！(常用)

##### 刪除、複製與貼上
x, X	在一列字當中，x 為向後刪除一個字元 (相當於 \[del] 按鍵)， X 為向前刪除一個字元(相當於 \[backspace] 亦即是倒退鍵) (常用)
nx	n 為數字，連續向後刪除 n 個字元。舉例來說，我要連續刪除 10 個字元， 『10x』。
dd	刪除游標所在的那一整列(常用)
ndd	n 為數字。刪除游標所在的向下 n 列，例如 20dd 則是刪除 20 列 (常用)
d1G	刪除游標所在到第一列的所有資料
dG	刪除游標所在到最後一列的所有資料
d\$	刪除游標所在處，到該列的最後一個字元
d0	那個是數字的 0 ，刪除游標所在處，到該列的最前面一個字元
yy	複製游標所在的那一列(常用)
nyy	n 為數字。複製游標所在的向下 n 列，例如 20yy 則是複製 20 列(常用)
y1G	複製游標所在列到第一列的所有資料
yG	複製游標所在列到最後一列的所有資料
y0	複製游標所在的那個字元到該列行首的所有資料
y\$	複製游標所在的那個字元到該列行尾的所有資料
p, P	p 為將已複製的資料在游標下一列貼上，P 則為貼在游標上一列！ 舉例來說，我目前游標在第 20 列，且已經複製了 10 列資料。則按下 p 後， 那 10 列資料會貼在原本的 20 列之後，亦即由 21 列開始貼。但如果是按下 P 呢？ 那麼原本的第 20 列會被推到變成 30 列。 (常用)
J	將游標所在列與下一列的資料結合成同一列
c	重複刪除多個資料，例如向下刪除 10 列，[ 10cj ]
u	復原前一個動作。(常用)
\[Ctrl]+r	重做上一個動作。(常用)
這個 u 與 \[Ctrl]+r 是很常用的指令！一個是復原，另一個則是重做一次～ 利用這兩個功能按鍵，你的編輯，嘿嘿！很快樂的啦！
.	不要懷疑！這就是小數點！意思是重複前一個動作的意思。 如果你想要重複刪除、重複貼上等等動作，按下小數點『.』就好了！ (常用)

#### 第二部份：一般指令模式切換到編輯模式的可用的按鈕說明
##### 進入插入或取代的編輯模式
i, I	進入插入模式(Insert mode)：
i 為『從目前游標所在處插入』， I 為『在目前所在列的第一個非空白字元處開始插入』。 (常用)
a, A	進入插入模式(Insert mode)：
a 為『從目前游標所在的下一個字元處開始插入』， A 為『從游標所在列的最後一個字元處開始插入』。(常用)
o, O	進入插入模式(Insert mode)：
這是英文字母 o 的大小寫。o 為『在目前游標所在的下一列處插入新的一列』； O 為在目前游標所在處的上一列插入新的一列！(常用)
r, R	進入取代模式(Replace mode)：
r 只會取代游標所在的那一個字元一次；R會一直取代游標所在的文字，直到按下 ESC 為止；(常用)
上面這些按鍵中，在 vi 畫面的左下角處會出現『--INSERT--』或『--REPLACE--』的字樣。 由名稱就知道該動作了吧！！特別注意的是，我們上面也提過了，你想要在檔案裡面輸入字元時， 一定要在左下角處看到 INSERT 或 REPLACE 才能輸入喔！
[Esc]	退出編輯模式，回到一般指令模式中(常用)

#### 第三部份：一般指令模式切換到指令列模式的可用按鈕說明
:w	將編輯的資料寫入硬碟檔案中(常用)
:w!	若檔案屬性為『唯讀』時，強制寫入該檔案。不過，到底能不能寫入， 還是跟你對該檔案的檔案權限有關啊！
:q	離開 vi (常用)
:q!	若曾修改過檔案，又不想儲存，使用 ! 為強制離開不儲存檔案。
注意一下啊，那個驚嘆號 (!) 在 vi 當中，常常具有『強制』的意思～
:wq	儲存後離開，若為 :wq! 則為強制儲存後離開 (常用)
ZZ	這是大寫的 Z 喔！若檔案沒有更動，則不儲存離開，若檔案已經被更動過，則儲存後離開！
:w [filename]	將編輯的資料儲存成另一個檔案（類似另存新檔）
:r [filename]	在編輯的資料中，讀入另一個檔案的資料。亦即將 『filename』 這個檔案內容加到游標所在列後面
:n1,n2 w [filename]	將 n1 到 n2 的內容儲存成 filename 這個檔案。
:! command	暫時離開 vi 到指令列模式下執行 command 的顯示結果！例如
『:! ls /home』即可在 vi 當中察看 /home 底下以 ls 輸出的檔案資訊！
##### vim 環境的變更
:set nu	顯示行號，設定之後，會在每一列的字首顯示該列的行號
:set nonu	與 set nu 相反，為取消行號！

特別注意，在 vi 中，『數字』是很有意義的！數字通常代表重複做幾次的意思！ 也有可能是代表去到第幾個什麼什麼的意思。舉例來說，要刪除 50 列，則是用 『50dd』 對吧！ 數字加在動作之前～那我要向下移動 20 列呢？那就是『20j』或者是『20↓』即可。

OK！會這些指令就已經很厲害了，因為常用到的指令也只有不到一半！通常 vi 的指令除了上面鳥哥註明的常用的幾個外，其他是不用背的，你可以做一張簡單的指令表在你的螢幕牆上， 一有疑問可以馬上的查詢呦！這也是當初鳥哥使用 vim 的方法啦！

### 9.2.3 一個案例練習
...

### 9.2.4 vim 的暫存檔、救援回復與開啟時的警告訊息
由於暫存檔存在的關係，因此 vim 會主動的判斷你的這個檔案可能有些問題，在上面的圖示中 vim 提示兩點主要的問題與解決方案，分別是這樣的：

- 問題一：可能有其他人或程式同時在編輯這個檔案：

    由於 Linux 是多人多工的環境，因此很可能有很多人同時在編輯同一個檔案。如果在多人共同編輯的情況下， 萬一大家同時儲存，那麼這個檔案的內容將會變的亂七八糟！為了避免這個問題，因此 vim 會出現這個警告視窗！ 解決的方法則是：

    找到另外那個程式或人員，請他將該 vim 的工作結束，然後你再繼續處理。

    如果你只是要看該檔案的內容並不會有任何修改編輯的行為，那麼可以選擇開啟成為唯讀(O)檔案， 亦即上述畫面反白部分輸入英文『 o 』即可，其實就是 [O]pen Read-Only 的選項啦！

- 問題二：在前一個 vim 的環境中，可能因為某些不知名原因導致 vim 中斷 (crashed)：

    這就是常見的不正常結束 vim 產生的後果。解決方案依據不同的情況而不同喔！常見的處理方法為：

    如果你之前的 vim 處理動作尚未儲存，此時你應該要按下『R』，亦即使用 (R)ecover 的項目， 此時 vim 會載入 .man_db.conf.swp 的內容，讓你自己來決定要不要儲存！這樣就能夠救回來你之前未儲存的工作。 不過那個 .man_db.conf.swp 並不會在你結束 vim 後自動刪除，所以你離開 vim 後還得要自行刪除 .man_db.conf.swp 才能避免每次打開這個檔案都會出現這樣的警告！

    如果你確定這個暫存檔是沒有用的，那麼你可以直接按下『D』刪除掉這個暫存檔，亦即 (D)elete it 這個項目即可。 此時 vim 會載入 man_db.conf ，並且將舊的 .man_db.conf.swp 刪除後，建立這次會使用的新的 .man_db.conf.swp 喔！

至於這個發現暫存檔警告訊息的畫面中，有出現六個可用按鈕，各按鈕的說明如下：

- [O]pen Read-Only：打開此檔案成為唯讀檔， 可以用在你只是想要查閱該檔案內容並不想要進行編輯行為時。一般來說，在上課時，如果你是登入到同學的電腦去看他的設定檔， 結果發現其實同學他自己也在編輯時，可以使用這個模式；

- (E)dit anyway：還是用正常的方式打開你要編輯的那個檔案， 並不會載入暫存檔的內容。不過很容易出現兩個使用者互相改變對方的檔案等問題！不好不好！

- (R)ecover：就是載入暫存檔的內容，用在你要救回之前未儲存的工作。 不過當你救回來並且儲存離開 vim 後，還是要手動自行刪除那個暫存檔喔！

- (D)elete it：你確定那個暫存檔是無用的！那麼開啟檔案前會先將這個暫存檔刪除！ 這個動作其實是比較常做的！因為你可能不確定這個暫存檔是怎麼來的，所以就刪除掉他吧！哈哈！

- (Q)uit：按下 q 就離開 vim ，不會進行任何動作回到命令提示字元。

- (A)bort：忽略這個編輯行為，感覺上與 quit 非常類似！ 也會送你回到命令提示字元就是囉！

## 9.3 vim 的額外功能
其實，目前大部分的 distributions 都以 vim 取代 vi 的功能了！如果你使用 vi 後，卻看到畫面的右下角有顯示目前游標所在的行列號碼，那麼你的 vi 已經被 vim 所取代囉～為什麼要用 vim 呢？因為 vim 具有顏色顯示的功能，並且還支援許多的程式語法 (syntax)， 因此，當你使用 vim 編輯程式時 (不論是 C 語言，還是 shell script )，我們的 vim 將可幫你直接進行『程式除錯 (debug)』的功能！真的很不賴吧！^_^

如果你在文字模式下，輸入 alias 時，出現這樣的畫面：
```
kevin@ubuntu:~/os$ alias
alias alert='notify-send --urgency=low -i "$([ $? = 0 ] && echo terminal || echo error)" "$(history|tail -n1|sed -e '\''s/^\s*[0-9]\+\s*//;s/[;&|]\s*alert$//'\'')"'
alias egrep='egrep --color=auto'
alias fgrep='fgrep --color=auto'
alias grep='grep --color=auto'
alias l='ls -CF'
alias la='ls -A'
alias ll='ls -alF'
alias ls='ls --color=auto'
```

區塊選擇的按鍵意義
v	字元選擇，會將游標經過的地方反白選擇！
V	列選擇，會將游標經過的列反白選擇！
\[Ctrl]+v	區塊選擇，可以用長方形的方式選擇資料
y	將反白的地方複製起來
d	將反白的地方刪除掉
p	將剛剛複製的區塊，在游標所在處貼上！

### 9.3.2 多檔案編輯
假設一個例子，你想要將剛剛我們的 hosts 內的 IP 複製到你的 /etc/hosts 這個檔案去， 那麼該如何編輯？我們知道在 vi 內可以使用 :r filename 來讀入某個檔案的內容， 不過，這樣畢竟是將整個檔案讀入啊！如果我只是想要部分內容呢？呵呵！這個時候多檔案同時編輯就很有用了。 我們可以使用 vim 後面同時接好幾個檔案來同時開啟喔！相關的按鍵有：

**多檔案編輯的按鍵**
| Syntax | Description |
| --- | ----------- |
| :n | 編輯下一個檔案 |
| :N | 編輯上一個檔案 |
| :files | 列出目前這個 vim 的開啟的所有檔案 |

| Syntax | Description |
| --- | ----------- |
|組合按鈕|	補齊的內容|
|[ctrl]+x -> [ctrl]+n|	透過目前正在編輯的這個『檔案的內容文字』作為關鍵字，予以補齊|
|[ctrl]+x -> [ctrl]+f|	以當前目錄內的『檔名』作為關鍵字，予以補齊|
|[ctrl]+x -> [ctrl]+o|	以副檔名作為語法補充，以 vim 內建的關鍵字，予以補齊|

### 9.3.5 vim 環境設定與記錄： ~/.vimrc, ~/.viminfo
...

### 9.3.6 vim 常用指令示意圖
<div align = center><img src="/os_note/vim/picture/vim-commands.jpg"></div>
<div align =center>圖9.3.10、vim 常用指令示意圖</div>

## 9.5 重點回顧
- Linux 底下的設定檔多為文字檔，故使用 vim 即可進行設定編輯；
- vim 可視為程式編輯器，可用以編輯 shell script, 設定檔等，避免打錯字；
- vi 為所有 unix like 的作業系統都會存在的編輯器，且執行速度快速；
- vi 有三種模式，一般指令模式可變換到編輯與指令列模式，但編輯模式與指令列模式不能互換；
- 常用的按鍵有i, [Esc], :wq 等；
- vi 的畫面大略可分為兩部份，(1)上半部的本文與(2)最後一行的狀態+指令列模式；
- 數字是有意義的，用來說明重複進行幾次動作的意思，如 5yy 為複製 5 列之意；
- 游標的移動中，大寫的 G 經常使用，尤其是 1G, G 移動到文章的頭/尾功能！
- vi 的取代功能也很棒！ :n1,n2s/old/new/g 要特別注意學習起來；
- 小數點『 . 』為重複進行前一次動作，也是經常使用的按鍵功能！
- 進入編輯模式幾乎只要記住： i, o, R 三個按鈕即可！尤其是新增一列的 o 與取代的 R
- vim 會主動的建立 swap 暫存檔，所以不要隨意斷線！
- 如果在文章內有對齊的區塊，可以使用 [ctrl]-v 進行複製/貼上/刪除的行為
- 使用 :sp 功能可以分割視窗
- 若使用 vim 來撰寫網頁，若需要 CSS 元素資料，可透過 [ctrl]+x, [ctrl]+o 這兩個連續組合按鍵來取得關鍵字
- vim 的環境設定可以寫入在 ~/.vimrc 檔案中；
- 可以使用 iconv 進行檔案語系編碼的轉換
- 使用 dos2unix 及 unix2dos 可以變更檔案每一列的行尾斷行字元。